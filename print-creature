#!/usr/bin/env python

import argparse
import re
import sys
from operator import itemgetter

import common
from common import space

parser = argparse.ArgumentParser()
parser.add_argument("--json", required=True)
parser.add_argument("--details", action="store_true")
args = parser.parse_args()

data = common.read_json_file(args.json)
stm = data['system']

print(data['name']);

abl = stm['abilities']
stats = [f"{a.upper()} {abl[a]['mod']}" for a in ['str', 'dex', 'con', 'int', 'wis', 'cha']]
print(', '.join(stats))

atr = stm['attributes']
os = ''
if atr['speed']['otherSpeeds']:
  os = [f"{os['type']} {os['value']}" for os in atr['speed']['otherSpeeds']]
  os = f" ({', '.join(os)})"
print(f"AC {atr['ac']['value']}, HP {atr['hp']['value']}, speed {atr['speed']['value']}{os}")

perc = stm['perception']
sens = [space(a['type'], a['range'], a['acuity']) for a in perc['senses']]
print(f"perc {perc['mod']} ({', '.join(sens)})")

svs = stm['saves']
stats = [f"{a[:4]} {svs[a]['value']}{svs[a]['saveDetail']}" for a in ['fortitude', 'reflex', 'will']]
print(', '.join(stats))

# TODO languages
# TODO skills

def parse_actions(t):
  if t == 'reaction':
    return '<-'
  elif t == 'passive':
    return '-'
  elif t == "1 to 3":
    return '*/**/***'
  else:
    m = re.match(r"(\d+) *(minutes?|hours?|days?)", str(t))
    if m:
      return f"{m.group(1)}{m.group(2)[:1]}"

    try:
      return '*' * int(t)
    except ValueError:
      return t


items = sorted(data['items'], key=itemgetter('sort'), reverse=True)
for i in items:
  s = i['system']
  title = i['name']

  actions = ' ' * 10
  if s['actions']['value']:
    actions += parse_actions(s['actions']['value'])
  elif s['actionType']['value']:
    actions += parse_actions(s['actionType']['value'])
  elif s['time']['value']:
    actions += parse_actions(s['time']['value'])
  else:
    actions += '*'
  title = f"{actions[-10:]} {title}"

  if 'bonus' in s:
    title += f" +{s['bonus']['value']}"

  if 'damageRolls' in s:
    dmg = [f"{d['damage']}{d['damageType'][0]}" for d in s['damageRolls'].values()]
    title += f" {', '.join(dmg)}"

  if 'level' in s:
    title += f" lv{s['level']['value']}"

  if s['duration']['sustained']:
    title += f" (sustained)"
  if s['duration']['value']:
    title += f" ({s['duration']['value']})"

  if s['attackEffects']['value']:
    title += f" --> {', '.join(s['attackEffects']['value'])}"

  i['heading'] = title

print('\n'.join([a['heading'] for a in items]))

if not args.details:
  sys.exit(0)

common.print_heading_and_html([
  (i['heading'], i['system']['description']['value'])
  for i in items])
